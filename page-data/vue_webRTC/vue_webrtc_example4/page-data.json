{"componentChunkName":"component---src-templates-post-template-tsx","path":"/vue_webRTC/vue_webrtc_example4/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h2>What to do?</h2>\n<ul>\n<li>Node.js 서버를 저번에 만들었는데, 여기에 webRTC 튜토리얼에 맞게 socket 서버안에 room을 만들기 위함</li>\n</ul>\n<h2>기존 코드</h2>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// index.js의 일부분</span>\nio<span class=\"token punctuation\">.</span>sockets<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connection'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">socket</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 연결되면 소켓 아이디를 콘솔에 출력</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>변경된 코드</h2>\n<ul>\n<li>추가된 부분에 대한 설명은 코드 블럭안에…</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">io<span class=\"token punctuation\">.</span>sockets<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connection'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">socket</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 연결되면 소켓 아이디를 콘솔에 출력</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// log 함수는 메세지를 클라이언트에 보내기 위한 함수임</span>\n  <span class=\"token comment\">// socket emit으로 log 이벤트와 args로 'array'를 보냄</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> array <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Message from server:'</span><span class=\"token punctuation\">]</span>\n    array<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>array<span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span>\n    socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'log'</span><span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// socket 이벤트인 'message'에 대한 핸들러를 추가</span>\n  <span class=\"token comment\">// socket.broadcast를 설정하게되면, sender 이외의 모든 유저에게 실행된다는 뜻</span>\n  <span class=\"token comment\">// 따라서, 서버를 먼저 개통한 sender를 제외한 나머지 클라이언트에 'message' 이벤트를 발생시킴</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'From Client: '</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// for a real app, would be room-only (not broadcast)</span>\n    socket<span class=\"token punctuation\">.</span>broadcast<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// socket 이벤트인 'create or join' 이벤트에 대한 핸들러 추가</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'create or join'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">room</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Received request to create or join room '</span> <span class=\"token operator\">+</span> room<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 'room'이름에 접속된 모든 소켓의 이름을 가져옴</span>\n    <span class=\"token keyword\">let</span> clientsInRoom <span class=\"token operator\">=</span> io<span class=\"token punctuation\">.</span>sockets<span class=\"token punctuation\">.</span>adapter<span class=\"token punctuation\">.</span>rooms<span class=\"token punctuation\">[</span>room<span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">// 몇 개의 소켓이 접속되있는지 count</span>\n    <span class=\"token keyword\">let</span> numClients <span class=\"token operator\">=</span> clientsInRoom\n      <span class=\"token operator\">?</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>clientsInRoom<span class=\"token punctuation\">.</span>sockets<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length\n      <span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Room '</span> <span class=\"token operator\">+</span> room <span class=\"token operator\">+</span> <span class=\"token string\">' now has '</span> <span class=\"token operator\">+</span> numClients <span class=\"token operator\">+</span> <span class=\"token string\">' client(s)'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 연결된 소켓이 0이면, room에 참가하고, 'created' 이벤트 발생시킴</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>numClients <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      socket<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>room<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Client ID '</span> <span class=\"token operator\">+</span> socket<span class=\"token punctuation\">.</span>id <span class=\"token operator\">+</span> <span class=\"token string\">' created room '</span> <span class=\"token operator\">+</span> room<span class=\"token punctuation\">)</span>\n      socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'created'</span><span class=\"token punctuation\">,</span> room<span class=\"token punctuation\">,</span> socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">// 연결된 소켓이 1이면, 이미 존재하는 room에 참가하고, `joined` 이벤트 발생시킴</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>numClients <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Client ID '</span> <span class=\"token operator\">+</span> socket<span class=\"token punctuation\">.</span>id <span class=\"token operator\">+</span> <span class=\"token string\">' joined room '</span> <span class=\"token operator\">+</span> room<span class=\"token punctuation\">)</span>\n      io<span class=\"token punctuation\">.</span>sockets<span class=\"token punctuation\">.</span><span class=\"token function\">in</span><span class=\"token punctuation\">(</span>room<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'join'</span><span class=\"token punctuation\">,</span> room<span class=\"token punctuation\">)</span>\n      socket<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>room<span class=\"token punctuation\">)</span>\n      socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'joined'</span><span class=\"token punctuation\">,</span> room<span class=\"token punctuation\">,</span> socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n      io<span class=\"token punctuation\">.</span>sockets<span class=\"token punctuation\">.</span><span class=\"token function\">in</span><span class=\"token punctuation\">(</span>room<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ready'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 2명 이상이 같은 방에 접속 못하도록, `full` 이벤트로 방지 (아무것도 안함)</span>\n      socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'full'</span><span class=\"token punctuation\">,</span> room<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// ipaddr 이벤트 ?</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ipaddr'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> ifaces <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">networkInterfaces</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ifaces<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> dev <span class=\"token keyword\">in</span> ifaces<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      ifaces<span class=\"token punctuation\">[</span>dev<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">details</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>details<span class=\"token punctuation\">.</span>family <span class=\"token operator\">===</span> <span class=\"token string\">'IPv4'</span> <span class=\"token operator\">&amp;&amp;</span> details<span class=\"token punctuation\">.</span>address <span class=\"token operator\">!==</span> <span class=\"token string\">'192.168.0.10'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ipaddr'</span><span class=\"token punctuation\">,</span> details<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 'bye' 이벤트 발생시, 콘솔에 메세지 출력</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bye'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'received bye'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<hr>\n<h2>마무리</h2>\n<ul>\n<li>수정 필요한 부분\n<ul>\n<li><code class=\"language-text\">ipaddr</code> 이벤트 핸들러에대한 설명 추가해야함.</li>\n</ul>\n</li>\n</ul>\n<p>다음에는 Vue에서 로컬 유저와 원격 유저가 1대 1로 비디오 채팅을 할 수 있도록 나머지를 설정 할 예정입니다.</p>","frontmatter":{"title":"[Vue+WebRTC] (4) Socket.io room 설정","excerpt":"Vue 프레임워크에 WebRTC 기술을 적용하여 웹캠 스트리밍 어플을 만드는 과정을 설명합니다.","date":"2019.08.05.","category":"vueRTC","thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQHA//EABYBAQEBAAAAAAAAAAAAAAAAAAEFCP/aAAwDAQACEAMQAAABQVqO8vPstKWJ/8QAGRAAAwEBAQAAAAAAAAAAAAAAAAIEFBID/9oACAEBAAEFAkmXryiqRcxkHn7Mh//EACIRAAEBBgcAAAAAAAAAAAAAAAERAAIDFiIxEiEyUVJxkf/aAAgBAwEBPwGYIiGu+HdaStJsFs8uoZNMETmfem//xAAgEQABAwIHAAAAAAAAAAAAAAABABEhFjIzQVFSYWOh/9oACAECAQE/AaqL4rCHDnKQ2k3bhCqvs9PC/8QAJRAAAAQEBQUAAAAAAAAAAAAAAQIDEgAEETEQEyIyoRQhQWGC/9oACAEBAAY/Ai5gCyoPbub5p7Dm0LdaVMD54py2TtVl07zg1EWlmHFBFK5GKOE3aLYBoIWgU01t9GNxS8Wj/8QAHBABAQACAwEBAAAAAAAAAAAAEQEAITFxkVGx/9oACAEBAAE/IenPPJs2BuSwH04VvZWxLUmtQdXTHjrPZn6sjAOgbIG2uDq9mf/aAAwDAQACAAMAAAAQIP8A/8QAHREBAQABBAMAAAAAAAAAAAAAAREhQVFhcZGhwf/aAAgBAwEBPxAm2btGIgmVhMSiM9bq+uDx3P/EAB0RAQABBAMBAAAAAAAAAAAAAAERACExYUFRkfD/2gAIAQIBAT8QUCTMymd5OaS1hHipdOPo7fNNf//EABsQAQACAwEBAAAAAAAAAAAAAAEAESEx8BDR/9oACAEBAAE/EAOmhYSwV6tXyWUUGmjDjl/NZlUnqE7/ABh7GRxBASMMVHVwR4r/AP/Z"},"images":{"fallback":{"src":"/static/f7a2cb1b53db588bfdc14d4b5dcd2d35/ffa24/logo.jpg","srcSet":"/static/f7a2cb1b53db588bfdc14d4b5dcd2d35/d04ec/logo.jpg 256w,\n/static/f7a2cb1b53db588bfdc14d4b5dcd2d35/6f7c6/logo.jpg 512w,\n/static/f7a2cb1b53db588bfdc14d4b5dcd2d35/ffa24/logo.jpg 1024w","sizes":"(min-width: 1024px) 1024px, 100vw"},"sources":[{"srcSet":"/static/f7a2cb1b53db588bfdc14d4b5dcd2d35/e92ac/logo.webp 256w,\n/static/f7a2cb1b53db588bfdc14d4b5dcd2d35/dcf1b/logo.webp 512w,\n/static/f7a2cb1b53db588bfdc14d4b5dcd2d35/afeb4/logo.webp 1024w","type":"image/webp","sizes":"(min-width: 1024px) 1024px, 100vw"}]},"width":1024,"height":768}},"publicURL":"/static/f7a2cb1b53db588bfdc14d4b5dcd2d35/logo.jpeg"}}}}]}},"pageContext":{"slug":"/vue_webRTC/vue_webrtc_example4/"}},"staticQueryHashes":[],"slicesMap":{}}